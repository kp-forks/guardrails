import CodeOutputBlock from '../../docusaurus/code-output-block.jsx';

```bash
guardrails hub install hub://guardrails/valid_choices --quiet
```

<CodeOutputBlock lang="bash">

```
    Installing hub://guardrails/valid_choices...
    ✅Successfully installed guardrails/valid_choices!
    
    
```

</CodeOutputBlock>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! Instead, edit the notebook w/the location & name as this file. -->

# Enforcing Guardrails on Choice Selection

!!! note
    To download this tutorial as a Jupyter notebook, click [here](https://github.com/guardrails-ai/guardrails/blob/main/docs/examples/select_choice_based_on_action.ipynb).

In this example, we want the LLM to pick an action (e.g. `fight` or `flight`), and based on that action we want to return different JSON objects. For example, if the action is `fight`, we want to return a JSON object that contains the `weapon` field. If the action is `flight`, we want to return a JSON object that contains the `direction` and `distance` fields.

We make the assumption that:

1. We don't need any external libraries that are not already installed in the environment.
2. We are able to execute the code in the environment.

## Objective

We want the LLM to play an RP game where it can choose to either `fight` or `flight`. If it chooses to `fight`, the LLM should choose a `weapon` and an `enemy`. If the player chooses `flight`, the LLM should choose a `direction` and a `distance`.

## Step 1: Generating `RAIL` Spec

Ordinarily, we could create a separate `RAIL` spec in a file. However, for the sake of this example, we will generate the `RAIL` spec in the notebook as a string or a Pydantic Model.

XML option:


```python
rail_str = """
<rail version="0.1">

<output>
    <choice name="action" on-fail-choice="reask" discriminator="chosen_action">
        <case name="fight">
            <string name="weapon" format="valid-choices: {['crossbow', 'machine gun']}" on-fail-valid-choices="reask" />
        </case>
        <case name="flight">
            <string name="flight_direction" format="valid-choices: {['north','south','east','west']}" on-fail-valid-choices="exception" />
            <integer name="distance" format="valid-choices: {[1,2,3,4]}" on-fail-valid-choices="exception" />
        </case>
    </choice>
</output>
<messages>
<message role="user">
You are a human in an enchanted forest. You come across opponents of different types, and you should fight smaller opponents and run away from bigger ones.

You run into a ${opp_type}. What do you do?

${gr.complete_xml_suffix_v2}
</message>
</messages>
</rail>
"""
```

Pydantic model option:


```python
from guardrails.hub import ValidChoices
from pydantic import BaseModel, Field
from typing import Literal, Union

prompt = """
You are a human in an enchanted forest. You come across opponents of different types, and you should fight smaller opponents and run away from bigger ones.

You run into a ${opp_type}. What do you do?

${gr.complete_xml_suffix_v2}"""


class Fight(BaseModel):
    chosen_action: Literal["fight"]
    weapon: str = Field(
        validators=[ValidChoices(["crossbow", "machine gun"], on_fail="reask")]
    )


class Flight(BaseModel):
    chosen_action: Literal["flight"]
    flight_direction: str = Field(
        validators=[
            ValidChoices(["north", "south", "east", "west"], on_fail="exception")
        ]
    )
    distance: int = Field(validators=[ValidChoices([1, 2, 3, 4], on_fail="exception")])


class FightOrFlight(BaseModel):
    action: Union[Fight, Flight] = Field(discriminator="chosen_action")
```

## Step 2: Create a `Guard` object with the RAIL Spec

We create a `gd.Guard` object that will check, validate and correct the generated code. This object:

1. Enforces the quality criteria specified in the RAIL spec (i.e. bug free code).
2. Takes corrective action when the quality criteria are not met (i.e. reasking the LLM).
3. Compiles the schema and type info from the RAIL spec and adds it to the prompt.

From XML:


```python
import guardrails as gd

from rich import print

guard = gd.Guard.for_rail_string(rail_str)
```

Or from Pydantic:


```python
import guardrails as gd


guard = gd.Guard.for_pydantic(output_class=FightOrFlight)
```

The `Guard` object compiles the output schema and adds it to the prompt.

## Step 3: Wrap the LLM API call with `Guard`

We can now wrap the LLM API call with the `Guard` object. This will ensure that the LLM generates an output that is compliant with the RAIL spec.

To start, we test with a 'giant' as an opponent, and look at the output.


```python
# Set your OPENAI_API_KEY as an environment variable
# import os
# os.environ["OPENAI_API_KEY"] = "YOUR_API_KEY"

raw_llm_response, validated_response, *rest = guard(
    messages=[{"role": "user", "content": prompt}],
    prompt_params={"opp_type": "giant"},
    model="gpt-4o-mini",
    max_tokens=256,
    temperature=0.0,
)
```

<CodeOutputBlock lang="python">

```
    /Users/dtam/dev/guardrails/guardrails/validator_service/__init__.py:85: UserWarning: Could not obtain an event loop. Falling back to synchronous validation.
      warnings.warn(
```

</CodeOutputBlock>

Running the cell above returns:
1. The raw LLM text output as a single string.
2. A dictionary where the key is `python_code` and the value is the generated code.

We can see that if the LLM chooses `flight`, the output is a dictionary with `flight_direction` and `distance` fields.


```python
print(validated_response)
```
    
<CodeOutputBlock dangerouslySetInnerHTML={{ __html: "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">'action'</span>: <span style=\"font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">'chosen_action'</span>: <span style=\"color: #008000; text-decoration-color: #008000\">'flight'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'flight_direction'</span>: <span style=\"color: #008000; text-decoration-color: #008000\">'north'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'distance'</span>: <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1</span><span style=\"font-weight: bold\">}}</span><br /></pre>"}} />

We can also see the final prompt below:


```python
print(guard.history.last.iterations.first.inputs.messages[0]["content"])
```
    
<CodeOutputBlock dangerouslySetInnerHTML={{ __html: "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><br />You are a human in an enchanted forest. You come across opponents of different types, and you should fight smaller <br />opponents and run away from bigger ones.<br /><br />You run into a giant. What do you do?<br /><br /><br />Given below is XML that describes the information to extract from this document and the tags to extract it into.<br /><br /><span style=\"font-weight: bold\">&lt;</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold\">output</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">  &lt;choice </span><span style=\"color: #808000; text-decoration-color: #808000\">discriminator</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"chosen_action\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"action\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">required</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"true\"</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">    &lt;case </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"fight\"</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">      &lt;string </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"guardrails/valid_choices: ['crossbow', 'machine gun']\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"weapon\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><br /><span style=\"color: #808000; text-decoration-color: #808000\">required</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"true\"</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">string</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">    &lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">case</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">    &lt;case </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"flight\"</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">      &lt;string </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"guardrails/valid_choices: ['north', 'south', 'east', 'west']\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"flight_direction\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><br /><span style=\"color: #808000; text-decoration-color: #808000\">required</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"true\"</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">string</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">      &lt;integer </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"guardrails/valid_choices: [1, 2, 3, 4]\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"distance\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">required</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"true\"</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">integer</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">    &lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">case</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">  &lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">choice</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">&lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">output</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><br /><span style=\"color: #000000; text-decoration-color: #000000\">ONLY return a valid JSON object </span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">(</span><span style=\"color: #000000; text-decoration-color: #000000\">no other text is necessary</span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">)</span><span style=\"color: #000000; text-decoration-color: #000000\">, where the key of the field in JSON is the `name` </span><br /><span style=\"color: #000000; text-decoration-color: #000000\">attribute of the corresponding XML, and the value is of the type specified by the corresponding XML's tag. The JSON</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">MUST conform to the XML format, including any types and format requests e.g. requests for lists, objects and </span><br /><span style=\"color: #000000; text-decoration-color: #000000\">specific types. Be correct and concise.</span><br /><br /><span style=\"color: #000000; text-decoration-color: #000000\">Here are examples of simple </span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">(</span><span style=\"color: #000000; text-decoration-color: #000000\">XML, JSON</span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">)</span><span style=\"color: #000000; text-decoration-color: #000000\"> pairs that show the expected behavior:</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">- `&lt;string </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">'foo'</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">'two-words lower-case'</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;` =&gt; `</span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">'foo'</span><span style=\"color: #000000; text-decoration-color: #000000\">: </span><span style=\"color: #008000; text-decoration-color: #008000\">'example one'</span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">}</span><span style=\"color: #000000; text-decoration-color: #000000\">`</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">- `&lt;list </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">'bar'</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;string </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">'upper-case'</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">list</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;` =&gt; `</span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">\"bar\"</span><span style=\"color: #000000; text-decoration-color: #000000\">: </span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'STRING ONE'</span><span style=\"color: #000000; text-decoration-color: #000000\">, </span><span style=\"color: #008000; text-decoration-color: #008000\">'STRING TWO'</span><span style=\"color: #000000; text-decoration-color: #000000\">, etc.</span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">]}</span><span style=\"color: #000000; text-decoration-color: #000000\">`</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">- `&lt;object </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">'baz'</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;string </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"foo\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"capitalize two-words\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;integer </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"index\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"1-indexed\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><br /><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">object</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;` =</span><span style=\"font-weight: bold\">&gt;</span> `<span style=\"font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">'baz'</span>: <span style=\"font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">'foo'</span>: <span style=\"color: #008000; text-decoration-color: #008000\">'Some String'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'index'</span>: <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1</span><span style=\"font-weight: bold\">}}</span>`<br /><br /></pre>"}} />

We can inspect the logs of the guard object to see the quality criteria that were checked and the corrective actions that were taken.


```python
print(guard.history.last.tree)
```
    
<CodeOutputBlock dangerouslySetInnerHTML={{ __html: "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">Logs<br />├── ╭────────────────────────────────────────────────── Step 0 ───────────────────────────────────────────────────╮<br />│   │ <span style=\"background-color: #e7dfeb\">╭─────────────────────────────────────────────── Messages ────────────────────────────────────────────────╮</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ ┏━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ ┃</span><span style=\"background-color: #e7dfeb; font-weight: bold\"> Role </span><span style=\"background-color: #e7dfeb\">┃</span><span style=\"background-color: #e7dfeb; font-weight: bold\"> Content                                                                                      </span><span style=\"background-color: #e7dfeb\">┃ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ ┡━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │ user │                                                                                              │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ You are a human in an enchanted forest. You come across opponents of different types, and    │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ you should fight smaller opponents and run away from bigger ones.                            │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ You run into a giant. What do you do?                                                        │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ Given below is XML that describes the information to extract from this document and the tags │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ to extract it into.                                                                          │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ &lt;output&gt;                                                                                     │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │   &lt;choice discriminator=\"chosen_action\" name=\"action\" required=\"true\"&gt;                       │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │     &lt;case name=\"fight\"&gt;                                                                      │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │       &lt;string format=\"guardrails/valid_choices: ['crossbow', 'machine gun']\" name=\"weapon\"   │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ required=\"true\"&gt;&lt;/string&gt;                                                                    │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │     &lt;/case&gt;                                                                                  │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │     &lt;case name=\"flight\"&gt;                                                                     │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │       &lt;string format=\"guardrails/valid_choices: ['north', 'south', 'east', 'west']\"          │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ name=\"flight_direction\" required=\"true\"&gt;&lt;/string&gt;                                            │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │       &lt;integer format=\"guardrails/valid_choices: [1, 2, 3, 4]\" name=\"distance\"               │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ required=\"true\"&gt;&lt;/integer&gt;                                                                   │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │     &lt;/case&gt;                                                                                  │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │   &lt;/choice&gt;                                                                                  │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ &lt;/output&gt;                                                                                    │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ ONLY return a valid JSON object (no other text is necessary), where the key of the field in  │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ JSON is the `name` attribute of the corresponding XML, and the value is of the type          │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ specified by the corresponding XML's tag. The JSON MUST conform to the XML format, including │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ any types and format requests e.g. requests for lists, objects and specific types. Be        │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ correct and concise.                                                                         │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ Here are examples of simple (XML, JSON) pairs that show the expected behavior:               │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ - `&lt;string name='foo' format='two-words lower-case' /&gt;` =&gt; `{'foo': 'example one'}`          │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ - `&lt;list name='bar'&gt;&lt;string format='upper-case' /&gt;&lt;/list&gt;` =&gt; `{\"bar\": ['STRING ONE',        │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ 'STRING TWO', etc.]}`                                                                        │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ - `&lt;object name='baz'&gt;&lt;string name=\"foo\" format=\"capitalize two-words\" /&gt;&lt;integer            │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ name=\"index\" format=\"1-indexed\" /&gt;&lt;/object&gt;` =&gt; `{'baz': {'foo': 'Some String', 'index':     │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ 1}}`                                                                                         │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ └──────┴──────────────────────────────────────────────────────────────────────────────────────────────┘ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">╭──────────────────────────────────────────── Raw LLM Output ─────────────────────────────────────────────╮</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">│ ```json                                                                                                 │</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">│ {                                                                                                       │</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">│   \"action\": \"flight\",                                                                                   │</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">│   \"flight_direction\": \"north\",                                                                          │</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">│   \"distance\": 3                                                                                         │</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">│ }                                                                                                       │</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">│ ```                                                                                                     │</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />│   │ <span style=\"background-color: #f0fff0\">╭─────────────────────────────────────────── Validated Output ────────────────────────────────────────────╮</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│ SkeletonReAsk(                                                                                          │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│     incorrect_value={'action': 'flight'},                                                               │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│     fail_results=[                                                                                      │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│         FailResult(                                                                                     │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│             outcome='fail',                                                                             │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│             error_message='JSON does not match schema:\n{\n  \"$.action\": [\n    \"\'flight\' is not      │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│ valid under any of the given schemas\"\n  ]\n}',                                                         │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│             fix_value=None,                                                                             │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│             error_spans=None,                                                                           │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│             metadata=None,                                                                              │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│             validated_chunk=None                                                                        │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│         )                                                                                               │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│     ],                                                                                                  │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│     additional_properties={}                                                                            │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│ )                                                                                                       │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />│   ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────╯<br />└── ╭────────────────────────────────────────────────── Step 1 ───────────────────────────────────────────────────╮<br />    │ <span style=\"background-color: #e7dfeb\">╭─────────────────────────────────────────────── Messages ────────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ ┏━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ ┃</span><span style=\"background-color: #e7dfeb; font-weight: bold\">   Role </span><span style=\"background-color: #e7dfeb\">┃</span><span style=\"background-color: #e7dfeb; font-weight: bold\"> Content                                                                                    </span><span style=\"background-color: #e7dfeb\">┃ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ ┡━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │ system │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ You are a helpful assistant only capable of communicating with valid JSON, and no other    │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ text.                                                                                      │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ ONLY return a valid JSON object (no other text is necessary), where the key of the field   │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ in JSON is the `name` attribute of the corresponding XML, and the value is of the type     │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ specified by the corresponding XML's tag. The JSON MUST conform to the XML format,         │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ including any types and format requests e.g. requests for lists, objects and specific      │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ types. Be correct and concise. If you are unsure anywhere, enter `null`.                   │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ Here are examples of simple (XML, JSON) pairs that show the expected behavior:             │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ - `&lt;string name='foo' format='two-words lower-case' /&gt;` =&gt; `{'foo': 'example one'}`        │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ - `&lt;list name='bar'&gt;&lt;string format='upper-case' /&gt;&lt;/list&gt;` =&gt; `{\"bar\": ['STRING ONE',      │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ 'STRING TWO', etc.]}`                                                                      │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ - `&lt;object name='baz'&gt;&lt;string name=\"foo\" format=\"capitalize two-words\" /&gt;&lt;integer          │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ name=\"index\" format=\"1-indexed\" /&gt;&lt;/object&gt;` =&gt; `{'baz': {'foo': 'Some String', 'index':   │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ 1}}`                                                                                       │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ ├────────┼────────────────────────────────────────────────────────────────────────────────────────────┤ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │   user │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ I was given the following JSON response, which had problems due to incorrect values.       │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ {                                                                                          │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │   \"incorrect_value\": {                                                                     │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │     \"action\": \"flight\"                                                                     │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │   },                                                                                       │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │   \"error_messages\": [                                                                      │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │     \"JSON does not match schema:\n{\n  \"$.action\": [\n    \"'flight' is not valid under  │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ any of the given schemas\"\n  ]\n}\"                                                        │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │   ]                                                                                        │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ }                                                                                          │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ Help me correct the incorrect values based on the given error messages.                    │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ Given below is XML that describes the information to extract from this document and the    │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ tags to extract it into.                                                                   │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ &lt;output&gt;                                                                                   │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │   &lt;choice discriminator=\"chosen_action\" name=\"action\" required=\"true\"&gt;                     │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │     &lt;case name=\"fight\"&gt;                                                                    │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │       &lt;string format=\"guardrails/valid_choices: ['crossbow', 'machine gun']\" name=\"weapon\" │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ required=\"true\"&gt;&lt;/string&gt;                                                                  │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │     &lt;/case&gt;                                                                                │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │     &lt;case name=\"flight\"&gt;                                                                   │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │       &lt;string format=\"guardrails/valid_choices: ['north', 'south', 'east', 'west']\"        │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ name=\"flight_direction\" required=\"true\"&gt;&lt;/string&gt;                                          │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │       &lt;integer format=\"guardrails/valid_choices: [1, 2, 3, 4]\" name=\"distance\"             │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ required=\"true\"&gt;&lt;/integer&gt;                                                                 │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │     &lt;/case&gt;                                                                                │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │   &lt;/choice&gt;                                                                                │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ &lt;/output&gt;                                                                                  │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ ONLY return a valid JSON object (no other text is necessary), where the key of the field   │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ in JSON is the `name` attribute of the corresponding XML, and the value is of the type     │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ specified by the corresponding XML's tag. The JSON MUST conform to the XML format,         │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ including any types and format requests e.g. requests for lists, objects and specific      │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ types. Be correct and concise. If you are unsure anywhere, enter `null`.                   │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ Here's an example of the structure:                                                        │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ {                                                                                          │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │   \"action\": {                                                                              │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │     \"chosen_action\": \"flight\",                                                             │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │     \"flight_direction\": \"hit\",                                                             │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │     \"distance\": 17                                                                         │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │   }                                                                                        │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ }                                                                                          │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ └────────┴────────────────────────────────────────────────────────────────────────────────────────────┘ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    │ <span style=\"background-color: #f5f5dc\">╭──────────────────────────────────────────── Raw LLM Output ─────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│ {                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│   \"action\": {                                                                                           │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│     \"chosen_action\": \"flight\",                                                                          │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│     \"flight_direction\": \"north\",                                                                        │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│     \"distance\": 1                                                                                       │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│   }                                                                                                     │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│ }                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    │ <span style=\"background-color: #f0fff0\">╭─────────────────────────────────────────── Validated Output ────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #f0fff0\">│ {                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│     'action': {                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│         'chosen_action': 'flight',                                                                      │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│         'flight_direction': 'north',                                                                    │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│         'distance': 1                                                                                   │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│     }                                                                                                   │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│ }                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f0fff0\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────╯<br /></pre>"}} />

Now, let's test with a `goblin` as an opponent.

We can see that the LLM chose to `fight` and the output is a choice of `weapon`.


```python
raw_llm_response, validated_response, *rest = guard(
    messages=[{"role": "user", "content": prompt}],
    prompt_params={"opp_type": "goblin"},
    model="gpt-4o-mini",
    max_tokens=256,
    temperature=0.0,
)
```

<CodeOutputBlock lang="python">

```
    /Users/dtam/dev/guardrails/guardrails/validator_service/__init__.py:85: UserWarning: Could not obtain an event loop. Falling back to synchronous validation.
      warnings.warn(
```

</CodeOutputBlock>


```python
print(validated_response)
```
    
<CodeOutputBlock dangerouslySetInnerHTML={{ __html: "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">'action'</span>: <span style=\"font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">'chosen_action'</span>: <span style=\"color: #008000; text-decoration-color: #008000\">'flight'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'flight_direction'</span>: <span style=\"color: #008000; text-decoration-color: #008000\">'north'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'distance'</span>: <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1</span><span style=\"font-weight: bold\">}}</span><br /></pre>"}} />

We can inspect the history of the guard after each call to see what happened.


```python
print(guard.history.last.tree)
```
    
<CodeOutputBlock dangerouslySetInnerHTML={{ __html: "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">Logs<br />├── ╭────────────────────────────────────────────────── Step 0 ───────────────────────────────────────────────────╮<br />│   │ <span style=\"background-color: #e7dfeb\">╭─────────────────────────────────────────────── Messages ────────────────────────────────────────────────╮</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ ┏━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ ┃</span><span style=\"background-color: #e7dfeb; font-weight: bold\"> Role </span><span style=\"background-color: #e7dfeb\">┃</span><span style=\"background-color: #e7dfeb; font-weight: bold\"> Content                                                                                      </span><span style=\"background-color: #e7dfeb\">┃ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ ┡━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │ user │                                                                                              │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ You are a human in an enchanted forest. You come across opponents of different types, and    │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ you should fight smaller opponents and run away from bigger ones.                            │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ You run into a goblin. What do you do?                                                       │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ Given below is XML that describes the information to extract from this document and the tags │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ to extract it into.                                                                          │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ &lt;output&gt;                                                                                     │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │   &lt;choice discriminator=\"chosen_action\" name=\"action\" required=\"true\"&gt;                       │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │     &lt;case name=\"fight\"&gt;                                                                      │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │       &lt;string format=\"guardrails/valid_choices: ['crossbow', 'machine gun']\" name=\"weapon\"   │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ required=\"true\"&gt;&lt;/string&gt;                                                                    │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │     &lt;/case&gt;                                                                                  │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │     &lt;case name=\"flight\"&gt;                                                                     │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │       &lt;string format=\"guardrails/valid_choices: ['north', 'south', 'east', 'west']\"          │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ name=\"flight_direction\" required=\"true\"&gt;&lt;/string&gt;                                            │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │       &lt;integer format=\"guardrails/valid_choices: [1, 2, 3, 4]\" name=\"distance\"               │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ required=\"true\"&gt;&lt;/integer&gt;                                                                   │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │     &lt;/case&gt;                                                                                  │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │   &lt;/choice&gt;                                                                                  │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ &lt;/output&gt;                                                                                    │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ ONLY return a valid JSON object (no other text is necessary), where the key of the field in  │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ JSON is the `name` attribute of the corresponding XML, and the value is of the type          │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ specified by the corresponding XML's tag. The JSON MUST conform to the XML format, including │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ any types and format requests e.g. requests for lists, objects and specific types. Be        │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ correct and concise.                                                                         │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ Here are examples of simple (XML, JSON) pairs that show the expected behavior:               │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ - `&lt;string name='foo' format='two-words lower-case' /&gt;` =&gt; `{'foo': 'example one'}`          │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ - `&lt;list name='bar'&gt;&lt;string format='upper-case' /&gt;&lt;/list&gt;` =&gt; `{\"bar\": ['STRING ONE',        │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ 'STRING TWO', etc.]}`                                                                        │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ - `&lt;object name='baz'&gt;&lt;string name=\"foo\" format=\"capitalize two-words\" /&gt;&lt;integer            │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ name=\"index\" format=\"1-indexed\" /&gt;&lt;/object&gt;` =&gt; `{'baz': {'foo': 'Some String', 'index':     │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │ 1}}`                                                                                         │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">│ └──────┴──────────────────────────────────────────────────────────────────────────────────────────────┘ │</span> │<br />│   │ <span style=\"background-color: #e7dfeb\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">╭──────────────────────────────────────────── Raw LLM Output ─────────────────────────────────────────────╮</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">│ ```json                                                                                                 │</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">│ {                                                                                                       │</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">│   \"action\": \"fight\",                                                                                    │</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">│   \"weapon\": \"crossbow\"                                                                                  │</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">│ }                                                                                                       │</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">│ ```                                                                                                     │</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />│   │ <span style=\"background-color: #f0fff0\">╭─────────────────────────────────────────── Validated Output ────────────────────────────────────────────╮</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│ SkeletonReAsk(                                                                                          │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│     incorrect_value={'action': 'fight'},                                                                │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│     fail_results=[                                                                                      │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│         FailResult(                                                                                     │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│             outcome='fail',                                                                             │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│             error_message='JSON does not match schema:\n{\n  \"$.action\": [\n    \"\'fight\' is not valid │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│ under any of the given schemas\"\n  ]\n}',                                                               │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│             fix_value=None,                                                                             │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│             error_spans=None,                                                                           │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│             metadata=None,                                                                              │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│             validated_chunk=None                                                                        │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│         )                                                                                               │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│     ],                                                                                                  │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│     additional_properties={}                                                                            │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│ )                                                                                                       │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />│   ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────╯<br />└── ╭────────────────────────────────────────────────── Step 1 ───────────────────────────────────────────────────╮<br />    │ <span style=\"background-color: #e7dfeb\">╭─────────────────────────────────────────────── Messages ────────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ ┏━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ ┃</span><span style=\"background-color: #e7dfeb; font-weight: bold\">   Role </span><span style=\"background-color: #e7dfeb\">┃</span><span style=\"background-color: #e7dfeb; font-weight: bold\"> Content                                                                                    </span><span style=\"background-color: #e7dfeb\">┃ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ ┡━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │ system │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ You are a helpful assistant only capable of communicating with valid JSON, and no other    │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ text.                                                                                      │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ ONLY return a valid JSON object (no other text is necessary), where the key of the field   │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ in JSON is the `name` attribute of the corresponding XML, and the value is of the type     │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ specified by the corresponding XML's tag. The JSON MUST conform to the XML format,         │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ including any types and format requests e.g. requests for lists, objects and specific      │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ types. Be correct and concise. If you are unsure anywhere, enter `null`.                   │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ Here are examples of simple (XML, JSON) pairs that show the expected behavior:             │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ - `&lt;string name='foo' format='two-words lower-case' /&gt;` =&gt; `{'foo': 'example one'}`        │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ - `&lt;list name='bar'&gt;&lt;string format='upper-case' /&gt;&lt;/list&gt;` =&gt; `{\"bar\": ['STRING ONE',      │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ 'STRING TWO', etc.]}`                                                                      │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ - `&lt;object name='baz'&gt;&lt;string name=\"foo\" format=\"capitalize two-words\" /&gt;&lt;integer          │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ name=\"index\" format=\"1-indexed\" /&gt;&lt;/object&gt;` =&gt; `{'baz': {'foo': 'Some String', 'index':   │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ 1}}`                                                                                       │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ ├────────┼────────────────────────────────────────────────────────────────────────────────────────────┤ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │   user │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ I was given the following JSON response, which had problems due to incorrect values.       │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ {                                                                                          │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │   \"incorrect_value\": {                                                                     │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │     \"action\": \"fight\"                                                                      │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │   },                                                                                       │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │   \"error_messages\": [                                                                      │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │     \"JSON does not match schema:\n{\n  \"$.action\": [\n    \"'fight' is not valid under   │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ any of the given schemas\"\n  ]\n}\"                                                        │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │   ]                                                                                        │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ }                                                                                          │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ Help me correct the incorrect values based on the given error messages.                    │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ Given below is XML that describes the information to extract from this document and the    │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ tags to extract it into.                                                                   │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ &lt;output&gt;                                                                                   │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │   &lt;choice discriminator=\"chosen_action\" name=\"action\" required=\"true\"&gt;                     │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │     &lt;case name=\"fight\"&gt;                                                                    │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │       &lt;string format=\"guardrails/valid_choices: ['crossbow', 'machine gun']\" name=\"weapon\" │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ required=\"true\"&gt;&lt;/string&gt;                                                                  │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │     &lt;/case&gt;                                                                                │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │     &lt;case name=\"flight\"&gt;                                                                   │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │       &lt;string format=\"guardrails/valid_choices: ['north', 'south', 'east', 'west']\"        │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ name=\"flight_direction\" required=\"true\"&gt;&lt;/string&gt;                                          │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │       &lt;integer format=\"guardrails/valid_choices: [1, 2, 3, 4]\" name=\"distance\"             │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ required=\"true\"&gt;&lt;/integer&gt;                                                                 │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │     &lt;/case&gt;                                                                                │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │   &lt;/choice&gt;                                                                                │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ &lt;/output&gt;                                                                                  │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ ONLY return a valid JSON object (no other text is necessary), where the key of the field   │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ in JSON is the `name` attribute of the corresponding XML, and the value is of the type     │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ specified by the corresponding XML's tag. The JSON MUST conform to the XML format,         │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ including any types and format requests e.g. requests for lists, objects and specific      │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ types. Be correct and concise. If you are unsure anywhere, enter `null`.                   │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ Here's an example of the structure:                                                        │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ {                                                                                          │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │   \"action\": {                                                                              │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │     \"chosen_action\": \"flight\",                                                             │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │     \"flight_direction\": \"form\",                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │     \"distance\": 63                                                                         │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │   }                                                                                        │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │ }                                                                                          │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │        │                                                                                            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ └────────┴────────────────────────────────────────────────────────────────────────────────────────────┘ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    │ <span style=\"background-color: #f5f5dc\">╭──────────────────────────────────────────── Raw LLM Output ─────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│ {                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│   \"action\": {                                                                                           │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│     \"chosen_action\": \"flight\",                                                                          │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│     \"flight_direction\": \"north\",                                                                        │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│     \"distance\": 1                                                                                       │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│   }                                                                                                     │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│ }                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    │ <span style=\"background-color: #f0fff0\">╭─────────────────────────────────────────── Validated Output ────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #f0fff0\">│ {                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│     'action': {                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│         'chosen_action': 'flight',                                                                      │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│         'flight_direction': 'north',                                                                    │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│         'distance': 1                                                                                   │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│     }                                                                                                   │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│ }                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f0fff0\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────╯<br /></pre>"}} />
