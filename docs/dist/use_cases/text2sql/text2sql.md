import CodeOutputBlock from '../../../code-output-block.jsx';

# Text-to-SQL

The `Text2SQL` module is a demonstration of how to use Guardrails to build a text-to-SQL workflow. It implements necessary components to build a text-to-SQL workflow, including:

- [x] Connects to your database
- [x] Given a DB schema, supports SQL validation and error handling
- [x] Finds relevant few shot examples of `text2SQL` history, and uses them to generate a prompt
- [x] Optionally adds modules to guard against unsafe SQL (allowing INSERT, DROP, etc.)
- [x] Supports reasking for all invalid SQL (SQL with syntax errors, SQL targeting non-existent tables, SQL with prohibited keywords, etc.)

!!! info
    The `text2SQL` module is intended to showcase what an end-to-end `text2SQL` workflow looks like with Guardrails. As a developer, you can either use this module as a starting point for your own `text2SQL` workflow or you can use it as a reference for how to use Guardrails to build your own custom `text2SQL` workflow.

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! Instead, edit the notebook w/the location & name as this file. -->

## 🎱  Why use Guardrails for text-to-SQL?

1. **`bug-free-sql` validators:** Guardrails provides a `bug-free-sql` validator that creates a sandboxed environment to run the generated SQL against your database and check for bugs and errors.
2. **Protection against unsafe SQL:** Guardrails allows developers to constrain the generated SQL to a subset of SQL that is safe to run against your database. For example, you can configure Guardrails to only allow `SELECT` statements, and disallow `INSERT`, `DROP`, etc.
3. **Reasking:** Guardrails allows you to configure reasking logic, so that if the generated SQL is invalid or has bugs, you can reask the LLM to generate a new SQL. Guardrails automatically handles the reasking logic for you.

## 🚀 Quickstart

To get started, you'll need the following:
1. Either a connection string to your database or a database schema
2. (Optional) Dictionary of few shot examples of `text2SQL` history


```python
import warnings

warnings.filterwarnings("ignore")
```


```python
import json

from rich import print

from guardrails.applications.text2sql import Text2Sql

# Set your OPENAI_API_KEY as an environment variable
# import os
# os.environ['OPENAI_API_KEY'] = "YOUR_API_KEY"
```

### 📝 Setup database connection and examples


```python
EXAMPLES = "examples.json"
SQL_SCHEMA = "schema.sql"
# Alternatively, you can specify a connection string instead of a schema file, like so:
# SQL_CONN = f"sqlite:///{os.getcwd()}department_management.sqlite"

with open(EXAMPLES, "r") as f:
    examples = json.load(f)

print(examples[:2])
```
    
<CodeOutputBlock dangerouslySetInnerHTML={{ __html: "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"font-weight: bold\">[</span><br />    <span style=\"font-weight: bold\">{</span><br />        <span style=\"color: #008000; text-decoration-color: #008000\">'question'</span>: <span style=\"color: #008000; text-decoration-color: #008000\">'How many heads of the departments are older than 56 ?'</span>,<br />        <span style=\"color: #008000; text-decoration-color: #008000\">'query'</span>: <span style=\"color: #008000; text-decoration-color: #008000\">'SELECT count(*) FROM head WHERE age  &gt;  56'</span><br />    <span style=\"font-weight: bold\">}</span>,<br />    <span style=\"font-weight: bold\">{</span><br />        <span style=\"color: #008000; text-decoration-color: #008000\">'question'</span>: <span style=\"color: #008000; text-decoration-color: #008000\">'List the name, born state and age of the heads of departments ordered by age.'</span>,<br />        <span style=\"color: #008000; text-decoration-color: #008000\">'query'</span>: <span style=\"color: #008000; text-decoration-color: #008000\">'SELECT name ,  born_state ,  age FROM head ORDER BY age'</span><br />    <span style=\"font-weight: bold\">}</span><br /><span style=\"font-weight: bold\">]</span><br /></pre>"}} />

### 💡 Use Text2SQL Application

- Sets up sandboxed DB based on your SQL schema / connection string
- Finds most relevant examples and inserts them into the prompt
- Checks that the query is valid for the schema


```python
app = Text2Sql(
    "sqlite://",
    schema_file=SQL_SCHEMA,
    examples=examples,
)

# Call the application with a natural language question.
print(app("What is the name of the department with the highest number of employees?"))
```
    
<CodeOutputBlock dangerouslySetInnerHTML={{ __html: "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">SELECT name FROM department ORDER BY Num_Employees DESC LIMIT <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1</span><br /></pre>"}} />

### ❎ Demonstration on an incorrect output

Below is a demonstration of how Guardrails' `Text2SQL` module handles an incorrect output from the LLM. The LLM generates an SQL that has a syntax error, and Guardrails catches this error and reasks the LLM to generate a new SQL.

The output is incorrect because it refers to a table (`departments`) that does not exist in the database. Guardrails catches this error and reasks the LLM to generate a new SQL.


```python
incorrect_llm_output = '{"generated_sql": "SELECT name FROM departments ORDER BY num_employees DESC LIMIT 1"}'

print(f"Incorrect output:\n\n{incorrect_llm_output}")
```
    
<CodeOutputBlock dangerouslySetInnerHTML={{ __html: "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">Incorrect output:<br /><br /><span style=\"font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">\"generated_sql\"</span>: <span style=\"color: #008000; text-decoration-color: #008000\">\"SELECT name FROM departments ORDER BY num_employees DESC LIMIT 1\"</span><span style=\"font-weight: bold\">}</span><br /></pre>"}} />

Below, we can see the final corrected output, as well as the underlying logs to see what happened step by step:


```python
from guardrails.llm_providers import openai_wrapper

output = app.guard.parse(
    llm_output=incorrect_llm_output,
    llm_api=openai_wrapper,
    engine="text-davinci-003",
    prompt_params={
        "nl_instruction": "What is the name of the department with the highest number of employees?",
        "db_info": str(app.sql_schema),
        "examples": "",
    },
    max_tokens=512,
)["generated_sql"]

print(f"Correct output:\n\n{output}")
```
    
<CodeOutputBlock dangerouslySetInnerHTML={{ __html: "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">Correct output:<br /><br />SELECT Name FROM department ORDER BY Num_Employees DESC LIMIT <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1</span><br /></pre>"}} />


```python
app.guard.history.last.tree
```
    
<CodeOutputBlock dangerouslySetInnerHTML={{ __html: "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">Logs<br />├── ╭────────────────────────────────────────────────── Step 0 ───────────────────────────────────────────────────╮<br />│   │ <span style=\"background-color: #f0f8ff\">╭──────────────────────────────────────────────── Prompt ─────────────────────────────────────────────────╮</span> │<br />│   │ <span style=\"background-color: #f0f8ff\">│ No prompt                                                                                               │</span> │<br />│   │ <span style=\"background-color: #f0f8ff\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">╭──────────────────────────────────────────── Raw LLM Output ─────────────────────────────────────────────╮</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">│ {\"generated_sql\": \"SELECT name FROM departments ORDER BY num_employees DESC LIMIT 1\"}                   │</span> │<br />│   │ <span style=\"background-color: #f5f5dc\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />│   │ <span style=\"background-color: #f0fff0\">╭─────────────────────────────────────────── Validated Output ────────────────────────────────────────────╮</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│ {                                                                                                       │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│     'generated_sql': ReAsk(                                                                             │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│         incorrect_value='SELECT name FROM departments ORDER BY num_employees DESC LIMIT 1',             │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│         error_message='(sqlite3.OperationalError) no such table: departments\n[SQL: SELECT name FROM    │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│ departments ORDER BY num_employees DESC LIMIT 1]\n(Background on this error at:                         │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│ https://sqlalche.me/e/20/e3q8)',                                                                        │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│         fix_value=None,                                                                                 │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│         path=['generated_sql']                                                                          │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│     )                                                                                                   │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">│ }                                                                                                       │</span> │<br />│   │ <span style=\"background-color: #f0fff0\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />│   ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────╯<br />└── ╭────────────────────────────────────────────────── Step 1 ───────────────────────────────────────────────────╮<br />    │ <span style=\"background-color: #f0f8ff\">╭──────────────────────────────────────────────── Prompt ─────────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ You are a data scientist whose job is to write SQL queries.                                             │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ Given below is XML that describes the information to extract from this document and the tags to extract │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ it into.                                                                                                │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ &lt;output&gt;                                                                                                │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     &lt;sql name=\"generated_sql\" description=\"Generate SQL for the given natural language instruction.\"    │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ format=\"bug-free-sql\"/&gt;                                                                                 │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ &lt;/output&gt;                                                                                               │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ ONLY return a valid JSON object (no other text is necessary), where the key of the field in JSON is the │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ `name` attribute of the corresponding XML, and the value is of the type specified by the corresponding  │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ XML's tag. The JSON MUST conform to the XML format, including any types and format requests e.g.        │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ requests for lists, objects and specific types. Be correct and concise.                                 │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ Here are examples of simple (XML, JSON) pairs that show the expected behavior:                          │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ - `&lt;string name='foo' format='two-words lower-case' /&gt;` =&gt; `{'foo': 'example one'}`                     │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ - `&lt;list name='bar'&gt;&lt;string format='upper-case' /&gt;&lt;/list&gt;` =&gt; `{\"bar\": ['STRING ONE', 'STRING TWO',     │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ etc.]}`                                                                                                 │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ - `&lt;object name='baz'&gt;&lt;string name=\"foo\" format=\"capitalize two-words\" /&gt;&lt;integer name=\"index\"          │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ format=\"1-indexed\" /&gt;&lt;/object&gt;` =&gt; `{'baz': {'foo': 'Some String', 'index': 1}}`                        │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ Here's schema about the database that you can use to generate the SQL query.                            │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ Try to avoid using joins if the data can be retrieved from the same table.                              │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ Table: department                                                                                       │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     Column: Department_ID                                                                               │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         type: INTEGER                                                                                   │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     Column: Name                                                                                        │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         type: TEXT                                                                                      │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     Column: Creation                                                                                    │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         type: TEXT                                                                                      │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     Column: Ranking                                                                                     │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         type: INTEGER                                                                                   │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     Column: Budget_in_Billions                                                                          │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         type: REAL                                                                                      │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     Column: Num_Employees                                                                               │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         type: REAL                                                                                      │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ Table: head                                                                                             │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     Column: head_ID                                                                                     │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         type: INTEGER                                                                                   │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     Column: name                                                                                        │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         type: TEXT                                                                                      │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     Column: born_state                                                                                  │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         type: TEXT                                                                                      │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     Column: age                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         type: REAL                                                                                      │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ Table: management                                                                                       │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     Column: department_ID                                                                               │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         type: INTEGER                                                                                   │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         foreign_key: {'table': 'department', 'column': 'Department_ID'}                                 │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     Column: head_ID                                                                                     │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         type: INTEGER                                                                                   │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         foreign_key: {'table': 'head', 'column': 'head_ID'}                                             │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     Column: temporary_acting                                                                            │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         type: TEXT                                                                                      │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ I will give you a list of examples.                                                                     │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ I want to create a query for the following instruction:                                                 │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ What is the name of the department with the highest number of employees?                                │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ For this instruction, I was given the following JSON, which has some incorrect values.                  │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ {                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│   \"generated_sql\": {                                                                                    │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     \"incorrect_value\": \"SELECT name FROM departments ORDER BY num_employees DESC LIMIT 1\",              │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     \"error_message\": \"(sqlite3.OperationalError) no such table: departments\n[SQL: SELECT name FROM     │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ departments ORDER BY num_employees DESC LIMIT 1]\n(Background on this error at:                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ https://sqlalche.me/e/20/e3q8)\"                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│   }                                                                                                     │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ }                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ Help me correct the incorrect values based on the given error messages.                                 │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    │ <span style=\"background-color: #f5f5dc\">╭──────────────────────────────────────────── Raw LLM Output ─────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│ {\"generated_sql\": \"SELECT Name FROM department ORDER BY Num_Employees DESC LIMIT 1\"}                    │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    │ <span style=\"background-color: #f0fff0\">╭─────────────────────────────────────────── Validated Output ────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #f0fff0\">│ {                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│     'generated_sql': 'SELECT Name FROM department ORDER BY Num_Employees DESC LIMIT 1'                  │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│ }                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f0fff0\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────╯<br /></pre>"}} />

## ⚒️ Customizing the `Text2SQL` module

You can customize the `Text2SQL` module to fit your needs. Here are some examples of how you can customize the module:

1. **Prompt:** You can customize the `text2SQL` prompt by passing in a custom `RAIL` spec to the module in the `rail_spec` argument.
2. **Few shot examples:** You can customize how the few shot examples are stored, retrieved, and inserted into the prompt by updating the arguments `vector_db`, `document_store`, `num_relevant_examples` and `example_formatter`.
3. **Reask prompt:** You can customize the reask prompt by updating the `reask_prompt` argument.
4. **LLM API:** You can customize the LLM API by updating the `llm_api` argument. To pass in specific kwargs to the LLM API, you can update the `llm_api_kwargs` argument (e.g. `llm_api_kwargs={'max_length': 100}`).


