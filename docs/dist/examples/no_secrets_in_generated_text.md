import CodeOutputBlock from '../../docusaurus/code-output-block.jsx';

# Generating strings that don't have any secrets

!!! note
    To download this example as a Jupyter notebook, click [here](https://github.com/guardrails-ai/guardrails/blob/main/docs/examples/no_secrets_in_generated_text.ipynb).

In this example, we will use Guardrails to generate strings that don't have any secrets.

This is also a good example to show how to use the custom Validators in the `RAIL` specification.

## Objective

We want to ask help with an API, but make sure that the generated text has no secrets.

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! Instead, edit the notebook w/the location & name as this file. -->

## Step 1: Create the RAIL Spec

Ordinarily, we would create an RAIL spec in a separate file. For the purposes of this example, we will create the spec in this notebook as a string following the RAIL syntax. For more information on RAIL, see the [RAIL documentation](/docs/how_to_guides/rail).  We will also show the same RAIL spec in a code-first format using a Pydantic model.

In this RAIL spec, we:

1. Create a custom Validator that checks if a string has any secrets. This is a simple example, but you can use this to create more complex Validators. For more information on creating custom Validators, see the [Validators documentation](/docs/hub/how_to_guides/custom_validator).
2. Create a `output` schema that returns an object with a `api_help` key.

First the custom Validator:


```python
from guardrails.validators import (
    Validator,
    register_validator,
    PassResult,
    FailResult,
    ValidationResult,
)

import re
from typing import Dict, Any

OPENAI_KEY_PATTERN = re.compile(r"sk-[a-zA-Z0-9]{24}")


@register_validator(name="no-code-secrets", data_type="string")
class NoCodeSecrets(Validator):
    def validate(self, value: Any, metadata: Dict) -> ValidationResult:
        global OPENAI_KEY_PATTERN

        if re.search(OPENAI_KEY_PATTERN, value) is not None:
            # Corrected value should replace the OpenAI API key with "sk-xxx"
            correct_value = re.sub(OPENAI_KEY_PATTERN, "sk-xxx", value)
            raise FailResult(
                error_message=f"Value {value} is an OpenAI API key.",
                fix_value=correct_value,
            )

        return PassResult()
```

Now we can use the validator in a Rail spec:


```python
rail_str = """
<rail version="0.1">


<output>
    <string name="api_help" description="Show an example curl command for using openai Completion API" format="no-code-secrets" on-fail-no-code-secrets="fix" />
</output>

<messages>
<message role="user">

How do I use OpenAI's Completion API?

${gr.complete_xml_suffix}
</message>
</messages>


</rail>
"""
```



Or in a Pydantic model:


```python
from pydantic import BaseModel, Field


prompt = """

How do I use OpenAI's Completion API?

${gr.complete_xml_suffix}
"""


class ScrubbedCode(BaseModel):
    api_help: str = Field(
        description="Show an example curl command for using openai Completion API",
        validators=[NoCodeSecrets(on_fail="fix")],
    )
```

## Step 2: Create a `Guard` object with the RAIL Spec

We create a `gd.Guard` object that will check, validate and correct the output of the LLM. This object:

1. Enforces the quality criteria specified in the RAIL spec.
2. Takes corrective action when the quality criteria are not met.
3. Compiles the schema and type info from the RAIL spec and adds it to the prompt.


```python
import guardrails as gd

from rich import print
```

From the XML RAIL spec:


```python
guard = gd.Guard.for_rail_string(rail_str)
```

Or from the Pydantic model:


```python
guard = gd.Guard.for_pydantic(output_class=ScrubbedCode)
```

## Step 3: Wrap the LLM API call with `Guard`

The `guard` wrapper returns the raw_llm_respose (which is a simple string), and the validated and corrected output (which is a dictionary).

We can see that the output is a dictionary with the correct schema and types.


```python
# Set your OPENAI_API_KEY as an environment variable
# import os
# os.environ["OPENAI_API_KEY"] = "YOUR_API_KEY"

raw_llm_response, validated_response, *rest = guard(
    model="gpt-4o-mini",
    max_tokens=3548,
    temperature=0,
    messages=[{"role": "user", "content": prompt}],
)
```

<CodeOutputBlock lang="python">

```
    /Users/dtam/dev/guardrails/guardrails/validator_service/__init__.py:85: UserWarning: Could not obtain an event loop. Falling back to synchronous validation.
      warnings.warn(
```

</CodeOutputBlock>

We can see the prompt that was sent to the LLM.


```python
print(guard.history.last.iterations.first.inputs.messages[0]["content"])
```
    
<CodeOutputBlock dangerouslySetInnerHTML={{ __html: "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><br /><br />How do I use OpenAI's Completion API?<br /><br /><br />Given below is XML that describes the information to extract from this document and the tags to extract it into.<br /><br /><span style=\"font-weight: bold\">&lt;</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold\">output</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">  &lt;string </span><span style=\"color: #808000; text-decoration-color: #808000\">description</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"Show an example curl command for using openai Completion API\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"no-code-secrets\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><br /><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"api_help\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">required</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"true\"</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">string</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">&lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">output</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><br /><span style=\"color: #000000; text-decoration-color: #000000\">ONLY return a valid JSON object </span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">(</span><span style=\"color: #000000; text-decoration-color: #000000\">no other text is necessary</span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">)</span><span style=\"color: #000000; text-decoration-color: #000000\">, where the key of the field in JSON is the `name` </span><br /><span style=\"color: #000000; text-decoration-color: #000000\">attribute of the corresponding XML, and the value is of the type specified by the corresponding XML's tag. The JSON</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">MUST conform to the XML format, including any types and format requests e.g. requests for lists, objects and </span><br /><span style=\"color: #000000; text-decoration-color: #000000\">specific types. Be correct and concise. If you are unsure anywhere, enter `null`.</span><br /><br /><span style=\"color: #000000; text-decoration-color: #000000\">Here are examples of simple </span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">(</span><span style=\"color: #000000; text-decoration-color: #000000\">XML, JSON</span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">)</span><span style=\"color: #000000; text-decoration-color: #000000\"> pairs that show the expected behavior:</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">- `&lt;string </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">'foo'</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">'two-words lower-case'</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;` =&gt; `</span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">'foo'</span><span style=\"color: #000000; text-decoration-color: #000000\">: </span><span style=\"color: #008000; text-decoration-color: #008000\">'example one'</span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">}</span><span style=\"color: #000000; text-decoration-color: #000000\">`</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">- `&lt;list </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">'bar'</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;string </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">'upper-case'</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">list</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;` =&gt; `</span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">\"bar\"</span><span style=\"color: #000000; text-decoration-color: #000000\">: </span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'STRING ONE'</span><span style=\"color: #000000; text-decoration-color: #000000\">, </span><span style=\"color: #008000; text-decoration-color: #008000\">'STRING TWO'</span><span style=\"color: #000000; text-decoration-color: #000000\">, etc.</span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">]}</span><span style=\"color: #000000; text-decoration-color: #000000\">`</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">- `&lt;object </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">'baz'</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;string </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"foo\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"capitalize two-words\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;integer </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"index\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"1-indexed\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><br /><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">object</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;` =</span><span style=\"font-weight: bold\">&gt;</span> `<span style=\"font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">'baz'</span>: <span style=\"font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">'foo'</span>: <span style=\"color: #008000; text-decoration-color: #008000\">'Some String'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'index'</span>: <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1</span><span style=\"font-weight: bold\">}}</span>`<br /><br /><br /></pre>"}} />


```python
print(validated_response)
```
    
<CodeOutputBlock dangerouslySetInnerHTML={{ __html: "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"font-weight: bold\">{</span><br />    <span style=\"color: #008000; text-decoration-color: #008000\">'api_help'</span>: <span style=\"color: #008000; text-decoration-color: #008000\">'curl https://api.openai.com/v1/completions -H \'Content-Type: application/json\' -H </span><br /><span style=\"color: #008000; text-decoration-color: #008000\">\'Authorization: Bearer YOUR_API_KEY\' -d \'{\"model\": \"text-davinci-003\", \"prompt\": \"Once upon a time\", </span><br /><span style=\"color: #008000; text-decoration-color: #008000\">\"max_tokens\": 50}\''</span><br /><span style=\"font-weight: bold\">}</span><br /></pre>"}} />


```python
print(guard.history.last.tree)
```
    
<CodeOutputBlock dangerouslySetInnerHTML={{ __html: "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">Logs<br />└── ╭────────────────────────────────────────────────── Step 0 ───────────────────────────────────────────────────╮<br />    │ <span style=\"background-color: #e7dfeb\">╭─────────────────────────────────────────────── Messages ────────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ ┏━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ ┃</span><span style=\"background-color: #e7dfeb; font-weight: bold\"> Role </span><span style=\"background-color: #e7dfeb\">┃</span><span style=\"background-color: #e7dfeb; font-weight: bold\"> Content                                                                                      </span><span style=\"background-color: #e7dfeb\">┃ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ ┡━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │ user │                                                                                              │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │ How do I use OpenAI's Completion API?                                                        │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │ Given below is XML that describes the information to extract from this document and the tags │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │ to extract it into.                                                                          │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │ &lt;output&gt;                                                                                     │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │   &lt;string description=\"Show an example curl command for using openai Completion API\"         │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │ format=\"no-code-secrets\" name=\"api_help\" required=\"true\"&gt;&lt;/string&gt;                           │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │ &lt;/output&gt;                                                                                    │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │ ONLY return a valid JSON object (no other text is necessary), where the key of the field in  │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │ JSON is the `name` attribute of the corresponding XML, and the value is of the type          │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │ specified by the corresponding XML's tag. The JSON MUST conform to the XML format, including │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │ any types and format requests e.g. requests for lists, objects and specific types. Be        │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │ correct and concise. If you are unsure anywhere, enter `null`.                               │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │ Here are examples of simple (XML, JSON) pairs that show the expected behavior:               │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │ - `&lt;string name='foo' format='two-words lower-case' /&gt;` =&gt; `{'foo': 'example one'}`          │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │ - `&lt;list name='bar'&gt;&lt;string format='upper-case' /&gt;&lt;/list&gt;` =&gt; `{\"bar\": ['STRING ONE',        │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │ 'STRING TWO', etc.]}`                                                                        │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │ - `&lt;object name='baz'&gt;&lt;string name=\"foo\" format=\"capitalize two-words\" /&gt;&lt;integer            │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │ name=\"index\" format=\"1-indexed\" /&gt;&lt;/object&gt;` =&gt; `{'baz': {'foo': 'Some String', 'index':     │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │ 1}}`                                                                                         │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ │      │                                                                                              │ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ └──────┴──────────────────────────────────────────────────────────────────────────────────────────────┘ │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    │ <span style=\"background-color: #f5f5dc\">╭──────────────────────────────────────────── Raw LLM Output ─────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│ {                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│   \"api_help\": \"curl https://api.openai.com/v1/completions -H 'Content-Type: application/json' -H        │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│ 'Authorization: Bearer YOUR_API_KEY' -d '{\"model\": \"text-davinci-003\", \"prompt\": \"Once upon a    │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│ time\", \"max_tokens\": 50}'\"                                                                           │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│ }                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    │ <span style=\"background-color: #f0fff0\">╭─────────────────────────────────────────── Validated Output ────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #f0fff0\">│ {                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│     'api_help': 'curl https://api.openai.com/v1/completions -H \'Content-Type: application/json\' -H    │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│ \'Authorization: Bearer YOUR_API_KEY\' -d \'{\"model\": \"text-davinci-003\", \"prompt\": \"Once upon a time\", │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│ \"max_tokens\": 50}\''                                                                                    │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│ }                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f0fff0\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────╯<br /></pre>"}} />
